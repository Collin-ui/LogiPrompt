<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LogiPrompt v2.3</title>

<!-- Roboto -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<!-- LKW-Favicon (Emoji, kein Upload n√∂tig) -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöö</text></svg>">

<style>
:root{
  --blue: #0077cc;
  --blue-dark:#005fa3;
  --bg: #f5faff;
  --card: #ffffff;
  --muted: #6b7280;
  --green: #00cc44;
  --danger: #e53935;
}
*{box-sizing:border-box}
body{margin:0;font-family:Roboto,Arial,sans-serif;background:var(--bg);color:#111}
header{background:var(--blue);color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
header .title{font-weight:700}
header .menu-toggle{font-size:20px;cursor:pointer;user-select:none}

/* layout */
#app{display:flex;min-height:calc(100vh - 56px)}
nav{
  width:260px;
  background:#eaf6ff;
  padding:18px;
  box-shadow:2px 0 6px rgba(0,0,0,0.05);
  transition:width .25s;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
nav.closed{width:64px}
nav .profile-thumb{width:56px;height:56px;border-radius:50%;object-fit:cover;display:block;margin:0 auto 12px}
nav ul{list-style:none;padding:0;margin:0}
nav li{background:#d8edff;padding:10px;border-radius:8px;margin-bottom:8px;text-align:center;cursor:pointer;transition:background .15s}
nav.closed li{padding:10px 6px}
nav li:hover{background:#bfe3ff}
nav .logout{background:var(--danger);color:#fff;padding:10px;border-radius:8px;border:none;cursor:pointer;width:100%}
nav .logout:hover{background:#c6372d}

/* main */
main{flex:1;padding:28px;position:relative;overflow-x:hidden}
.card{max-width:480px;margin:5% auto;background:var(--card);padding:26px;border-radius:12px;box-shadow:0 8px 20px rgba(10,30,60,0.06)}
.card h2{text-align:center;margin:0 0 12px;font-size:22px}
input,select,textarea,button{width:100%;padding:10px 12px;margin:8px 0;border-radius:8px;border:1px solid #d1d5db;font-size:15px}
label.inline{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted)}
.small{font-size:13px;color:var(--muted)}
.row{display:flex;gap:10px}
.row> *{flex:1}

/* tooltip */
.tooltip{display:inline-block;position:relative;color:var(--blue);font-weight:700;margin-right:8px;cursor:help}
.tooltip .tt{visibility:hidden;width:240px;background:var(--blue);color:#fff;padding:8px;border-radius:6px;position:absolute;bottom:130%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .18s}
.tooltip:hover .tt{visibility:visible;opacity:1}

/* prompt area */
#promptOutput{background:#fbfeff;border:1px solid #e6f7ff;padding:12px;border-radius:8px;min-height:78px;white-space:pre-wrap;margin-top:12px;display:none} /* hidden by default per spec */
#promptStatus{margin-top:10px;color:var(--blue);font-weight:700}
#truckAnimation{
  width:92px;height:56px;
  position:absolute; top:18px; left:-140px;
  transition:transform 1.8s cubic-bezier(.2,.9,.2,1);
  z-index:999;
  pointer-events:none;
}

/* rating */
#rating{display:flex;gap:8px;margin-top:12px}
.box{width:36px;height:36px;border-radius:6px;background:#eee;border:1px solid #d1d5db}
.box.active{background:var(--green);border-color:rgba(0,0,0,0.06)}

/* favorites */
.fav-item{border:1px solid #e6eef8;padding:10px;border-radius:8px;margin-bottom:8px;background:#fff}
.fav-meta{font-size:12px;color:var(--muted);margin-bottom:6px}

/* small screens */
@media (max-width:900px){
  nav{display:none}
  .card{margin:7% 12px}
  header{padding:12px}
}
</style>
</head>
<body>
<header>
  <div class="title">LogiPrompt v2.3</div>
  <div class="menu-toggle" id="menuToggle">‚ò∞</div>
</header>

<div id="app">
  <!-- Sidebar (hidden until login) -->
  <nav id="sideMenu" style="display:none" class="closed" aria-hidden="true">
    <div>
      <img id="profilePicMenu" class="profile-thumb" src="https://via.placeholder.com/56?text=LP" alt="Profilbild">
      <ul>
        <li id="navProfile">Profil</li>
        <li id="navPrompt">Prompt Erstellung</li>
        <li id="navFavs">Favoriten</li>
      </ul>
    </div>

    <div>
      <button id="btnLogout" class="logout">Abmelden</button>
    </div>
  </nav>

  <main id="mainContent">
    <!-- Minimalistischer LKW (SVG als data URI: keine externe Datei n√∂tig) -->
    <img id="truckAnimation" alt="LKW"
      src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='100' viewBox='0 0 180 100'><rect rx='8' ry='8' x='4' y='24' width='110' height='52' fill='%230077cc'/><rect x='112' y='36' width='52' height='40' fill='%23005599'/><circle cx='40' cy='78' r='10' fill='%23000000'/><circle cx='132' cy='78' r='10' fill='%23000000'/></svg>">

    <!-- LOGIN (Start) -->
    <div id="loginPage" class="card" role="region" aria-label="Login">
      <h2>Anmeldung / Registrierung</h2>

      <input id="name" type="text" placeholder="Name" autocomplete="name">
      <input id="role" type="text" placeholder="Rolle in der Firma">
      <input id="company" type="text" placeholder="Firmenname">
      <input id="email" type="email" placeholder="E-Mail">
      <input id="password" type="password" placeholder="Passwort">

      <label class="inline"><input id="stayLoggedIn" type="checkbox"> Angemeldet bleiben</label>

      <div class="row" style="margin-top:12px">
        <button class="ghost" id="btnContinue">Weiter</button>
        <button class="primary" id="btnSaveContinue">Speichern &amp; Fortsetzen</button>
      </div>

      <p class="small" style="margin-top:10px">Hinweis: Mit <strong>Weiter</strong> gelangst du zur Prompt-Erstellung (keine Speicherung). Mit <strong>Speichern &amp; Fortsetzen</strong> werden die Account-Daten lokal gespeichert.</p>
    </div>

    <!-- PROFILE -->
    <div id="profilePage" class="card" style="max-width:760px;margin-left:auto;margin-right:auto;display:none">
      <h2>Profil</h2>
      <div class="row">
        <div style="flex:1">
          <input id="profileName" type="text" placeholder="Name">
          <input id="profileRole" type="text" placeholder="Rolle in der Firma">
          <input id="profileCompany" type="text" placeholder="Firmenname">
          <input id="profileEmail" type="email" placeholder="E-Mail">
        </div>
        <div style="width:160px;text-align:center">
          <img id="profilePreview" src="https://via.placeholder.com/120?text=LP" alt="Profilfoto" style="width:120px;height:120px;border-radius:12px;object-fit:cover;margin-bottom:8px">
          <input id="profilePic" type="file" accept="image/*">
          <button class="ghost" id="btnRemovePic">Bild entfernen</button>
        </div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="ghost" id="btnProfileCancel">Abbrechen</button>
        <button class="primary" id="btnSaveProfile">Profil speichern</button>
      </div>

      <div id="profileStatus" class="status" style="display:none" aria-live="polite"></div>
    </div>

    <!-- PROMPT -->
    <div id="promptPage" class="card" style="max-width:880px;margin-left:auto;margin-right:auto;display:none">
      <h2>Prompt Erstellung</h2>

      <div style="margin-bottom:8px">
        <label class="tooltip">i<span class="tt">Gib das Thema des Prompts ein (z.B. Ermahnung)</span></label>
        <input id="keyword" type="text" placeholder="Schl√ºsselwort / Thema">
      </div>

      <div style="margin-bottom:8px">
        <label class="tooltip">i<span class="tt">Zus√§tzliche Informationen (z.B. Hintergrund, Kontext)</span></label>
        <textarea id="additionalInfo" rows="2" placeholder="Zus√§tzliche Informationen (optional)"></textarea>
      </div>

      <div class="row">
        <div>
          <select id="recipientRole">
            <option value="">Adressat / Rolle ausw√§hlen</option>
            <option>Fahrerpersonal</option>
            <option>Disposition</option>
            <option>Verwaltung</option>
            <option>Gesch√§ftsf√ºhrung</option>
            <option>Kunde</option>
            <option>Partnerfirma</option>
          </select>
        </div>
        <div>
          <input id="recipientName" type="text" placeholder="Empf√§nger / Name">
        </div>
      </div>

      <div class="row">
        <div>
          <select id="tone">
            <option value="">Tonfall ausw√§hlen</option>
            <option>Ernst</option>
            <option>Freundlich</option>
            <option>L√∂sungsorientiert</option>
            <option>Motivierend</option>
            <option>Neutral</option>
          </select>
        </div>
        <div>
          <select id="textFormat">
            <option value="">Textformat ausw√§hlen</option>
            <option>Email</option>
            <option>Teamsnachricht</option>
            <option>Brief</option>
            <option>Chatnachricht</option>
            <option>Dokumentation</option>
            <option>Bericht</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <select id="language">
            <option value="">Sprache ausw√§hlen</option>
            <option>Deutsch</option>
            <option>Englisch</option>
            <option>Franz√∂sisch</option>
            <option>Russisch</option>
          </select>
        </div>
        <div style="display:flex;align-items:end;gap:10px">
          <button class="primary" id="btnGenerate">Prompt generieren</button>
          <button class="ghost" id="btnReset">Zur√ºcksetzen</button>
        </div>
      </div>

      <!-- Prompt is intentionally not shown in full in UI before copy,
           as requested. We store it in currentPrompt and allow copying/saving. -->
      <div id="promptStatus" class="status" style="display:none" aria-live="polite"></div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="ghost" id="btnCopy">Prompt kopieren</button>
        <button class="ghost" id="btnSaveFav">Zu Favoriten hinzuf√ºgen</button>
      </div>

      <div id="rating" style="margin-top:12px">
        <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
      </div>
    </div>

    <!-- FAVORITES -->
    <div id="favoritesPage" class="card" style="max-width:880px;margin-left:auto;margin-right:auto;display:none">
      <h2>Favoriten</h2>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
        <label class="small">Sortieren:
          <select id="sortFavorites">
            <option value="newest">Neueste ‚Üí √Ñlteste</option>
            <option value="oldest">√Ñlteste ‚Üí Neueste</option>
          </select>
        </label>
        <input id="filterFavs" placeholder="Filter (z. B. Empf√§nger oder Thema)">
        <div style="flex:1"></div>
        <button class="ghost" id="btnClearFavs">Alle l√∂schen</button>
      </div>
      <div id="favoritesList"></div>
    </div>
  </main>
</div>

<script>
/* ----------------------
   State & Storage keys
   ---------------------- */
const KEY_USER = 'logiprompt_user_v2';
const KEY_FAVS = 'logiprompt_favs_v2';

let userData = {};           // session or loaded from localStorage
let currentPrompt = '';      // holds the generated prompt text (hidden from UI until copied)
let favs = [];               // favorites array

/* ----------------------
   Short helpers
   ---------------------- */
const el = id => document.getElementById(id);
const show = id => el(id).style.display = '';
const hide = id => el(id).style.display = 'none';
const isVisible = id => el(id).style.display !== 'none';
const showPopup = (msg, ms=1400) => {
  const p = document.createElement('div');
  p.textContent = msg;
  Object.assign(p.style, {
    position:'fixed', right:'18px', bottom:'18px', background: 'var(--blue)', color:'#fff',
    padding:'10px 14px', borderRadius:'8px', boxShadow:'0 8px 20px rgba(0,0,0,0.12)', zIndex:9999
  });
  document.body.appendChild(p);
  setTimeout(()=> p.remove(), ms);
}

/* ----------------------
   Init: DOM refs
   ---------------------- */
const sideMenu = el('sideMenu');
const menuToggle = el('menuToggle');
const loginPage = el('loginPage');
const profilePage = el('profilePage');
const promptPage = el('promptPage');
const favoritesPage = el('favoritesPage');
const profilePicInput = el('profilePic');
const profilePreview = el('profilePreview');
const truckAnim = el('truckAnimation');
const ratingBoxes = [...document.querySelectorAll('#rating .box')];

/* ----------------------
   Menu toggle & nav
   ---------------------- */
menuToggle.addEventListener('click', () => {
  if (window.innerWidth < 900) {
    sideMenu.style.display = sideMenu.style.display === 'block' ? 'none' : 'block';
  } else {
    sideMenu.classList.toggle('closed');
  }
});
el('navProfile').addEventListener('click', ()=> { openProfile(); });
el('navPrompt').addEventListener('click', ()=> { openPrompt(); });
el('navFavs').addEventListener('click', ()=> { openFavorites(); });

/* ----------------------
   Login actions
   ---------------------- */
// Continue (no persist)
el('btnContinue').addEventListener('click', () => {
  // build session userData (not persisted)
  userData = {
    name: el('name').value.trim(),
    role: el('role').value.trim(),
    company: el('company').value.trim(),
    email: el('email').value.trim(),
    password: el('password').value
  };
  // show menu & prompt page
  sideMenu.style.display = 'block';
  el('profilePicMenu').src = userData.profilePic || 'https://via.placeholder.com/56?text=LP';
  populateProfileFieldsFromUserData();
  openPrompt();
});

// Save & Continue (persist)
el('btnSaveContinue').addEventListener('click', () => {
  const name = el('name').value.trim();
  const role = el('role').value.trim();
  const company = el('company').value.trim();
  const email = el('email').value.trim();
  const password = el('password').value;

  if(!name || !role || !company || !email || !password){
    alert('Bitte alle Felder ausf√ºllen, um zu speichern.');
    return;
  }
  userData = { name, role, company, email, password, profilePic: null };
  localStorage.setItem(KEY_USER, JSON.stringify(userData));
  if(el('stayLoggedIn').checked) localStorage.setItem(KEY_USER+'_stay', '1');
  showPopup('Account gespeichert!');
  sideMenu.style.display = 'block';
  el('profilePicMenu').src = userData.profilePic || 'https://via.placeholder.com/56?text=LP';
  populateProfileFieldsFromUserData();
  openPrompt();
});

/* Auto login if saved and stay */
window.addEventListener('load', () => {
  const saved = localStorage.getItem(KEY_USER);
  const stay = localStorage.getItem(KEY_USER+'_stay');
  const favSaved = localStorage.getItem(KEY_FAVS);
  if (favSaved) {
    try { favs = JSON.parse(favSaved) } catch(e){ favs = [] }
  }
  if (saved && stay) {
    userData = JSON.parse(saved);
    sideMenu.style.display = 'block';
    el('profilePicMenu').src = userData.profilePic || 'https://via.placeholder.com/56?text=LP';
    populateProfileFieldsFromUserData();
    openPrompt();
  } else {
    // show login
    openLogin();
  }
});

/* ----------------------
   Navigation helpers
   ---------------------- */
function openLogin(){
  hide('profilePage'); hide('promptPage'); hide('favoritesPage');
  show('loginPage');
  sideMenu.style.display = 'none';
}
function openProfile(){
  hide('loginPage'); hide('promptPage'); hide('favoritesPage');
  show('profilePage'); hide('profileStatus');
  populateProfileFieldsFromUserData();
}
function openPrompt(){
  hide('loginPage'); hide('profilePage'); hide('favoritesPage');
  show('promptPage');
}
function openFavorites(){
  hide('loginPage'); hide('profilePage'); hide('promptPage');
  show('favoritesPage');
  renderFavorites();
}

/* ----------------------
   Profile handling
   ---------------------- */
function populateProfileFieldsFromUserData(){
  el('profileName').value = userData.name || '';
  el('profileRole').value = userData.role || '';
  el('profileCompany').value = userData.company || '';
  el('profileEmail').value = userData.email || '';
  if (userData.profilePic) {
    profilePreview.src = userData.profilePic;
    el('profilePicMenu').src = userData.profilePic;
  }
}

profilePicInput.addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    profilePreview.src = ev.target.result;
    el('profilePicMenu').src = ev.target.result;
    // store in userData immediately (persist only if saved user exists)
    userData.profilePic = ev.target.result;
    const saved = localStorage.getItem(KEY_USER);
    if (saved) {
      const u = JSON.parse(saved);
      u.profilePic = ev.target.result;
      localStorage.setItem(KEY_USER, JSON.stringify(u));
    }
  };
  reader.readAsDataURL(f);
});

el('btnRemovePic').addEventListener('click', () => {
  profilePreview.src = 'https://via.placeholder.com/120?text=LP';
  el('profilePicMenu').src = 'https://via.placeholder.com/56?text=LP';
  profilePicInput.value = '';
  if (userData) { userData.profilePic = null; }
  const saved = localStorage.getItem(KEY_USER);
  if (saved) {
    const u = JSON.parse(saved);
    delete u.profilePic;
    localStorage.setItem(KEY_USER, JSON.stringify(u));
  }
});

el('btnProfileCancel').addEventListener('click', () => {
  populateProfileFieldsFromUserData();
  openPrompt();
});

el('btnSaveProfile').addEventListener('click', () => {
  if (!userData) userData = {};
  userData.name = el('profileName').value.trim();
  userData.role = el('profileRole').value.trim();
  userData.company = el('profileCompany').value.trim();
  userData.email = el('profileEmail').value.trim();
  // save to localStorage if user saved before
  const saved = localStorage.getItem(KEY_USER);
  if (saved) {
    const u = JSON.parse(saved);
    Object.assign(u, userData);
    localStorage.setItem(KEY_USER, JSON.stringify(u));
  } else {
    // don't force saving, but allow local persistence of profile
    localStorage.setItem(KEY_USER, JSON.stringify(userData));
  }
  el('profileStatus').textContent = 'Profil gespeichert!';
  el('profileStatus').style.display = 'block';
  setTimeout(()=> el('profileStatus').style.display = 'none', 1400);
  el('profilePicMenu').src = userData.profilePic || 'https://via.placeholder.com/56?text=LP';
});

/* ----------------------
   Logout (confirm + clear)
   ---------------------- */
el('btnLogout').addEventListener('click', () => {
  const ok = confirm('Willst du dich wirklich abmelden? Alle lokal gespeicherten Daten (Account & Favoriten) werden gel√∂scht.');
  if (!ok) return;
  localStorage.removeItem(KEY_USER);
  localStorage.removeItem(KEY_USER + '_stay');
  localStorage.removeItem(KEY_FAVS);
  userData = {};
  favs = [];
  currentPrompt = '';
  el('profilePicMenu').src = 'https://via.placeholder.com/56?text=LP';
  openLogin();
  showPopup('Abgemeldet ‚Äî lokale Daten gel√∂scht');
});

/* ----------------------
   Prompt logic
   ---------------------- */
function countFilledPromptFields(){
  const fields = [
    el('keyword').value.trim(),
    el('additionalInfo').value.trim(),
    el('recipientRole').value,
    el('recipientName').value.trim(),
    el('tone').value,
    el('textFormat').value,
    el('language').value
  ];
  return fields.filter(f => f && String(f).trim().length>0).length;
}

function updateRating(){
  const count = countFilledPromptFields();
  const boxes = ratingBoxes;
  // map count (0..7) to 0..5 boxes
  const boxesToFill = Math.round(count / 7 * 5);
  boxes.forEach((b, i) => b.classList.toggle('active', i < boxesToFill));
}

el('keyword').addEventListener('input', updateRating);
el('additionalInfo').addEventListener('input', updateRating);
el('recipientRole').addEventListener('change', updateRating);
el('recipientName').addEventListener('input', updateRating);
el('tone').addEventListener('change', updateRating);
el('textFormat').addEventListener('change', updateRating);
el('language').addEventListener('change', updateRating);

/* Generate prompt (minimalist LKW animation) */
el('btnGenerate').addEventListener('click', () => {
  const keyword = el('keyword').value.trim();
  const additional = el('additionalInfo').value.trim();
  const recipientRole = el('recipientRole').value;
  const recipientName = el('recipientName').value.trim();
  const tone = el('tone').value;
  const textFormat = el('textFormat').value;
  const language = el('language').value;

  if (!keyword && !additional && !recipientName && !recipientRole && !tone && !textFormat && !language) {
    alert('Bitte mindestens ein Feld ausf√ºllen, um einen Prompt zu generieren!');
    return;
  }

  // minimal LKW animation: move across mainContent and then generate
  truckAnim.style.transition = 'none';
  truckAnim.style.transform = 'translateX(0)'; // ensure starting pos
  truckAnim.style.left = '-140px';
  // small delay to allow style reset
  setTimeout(()=> {
    const mainWidth = el('mainContent').offsetWidth;
    truckAnim.style.transition = 'transform 1.2s cubic-bezier(.2,.9,.2,1)';
    truckAnim.style.transform = `translateX(${mainWidth + 160}px)`;
  }, 40);

  // Generate final prompt after animation time
  setTimeout(()=> {
    const base = "Erstelle eine professionelle Nachricht zum Thema [Thema], aufgrund [zus√§tzliche Informationen], f√ºr [Empf√§nger] in der Rolle [Rolle] im Ton [Tonfall] im Format [Textformat] auf [Sprache]. Absender ist [Name], [Rolle in der Firma] bei [Firmenname], erreichbar unter [E-Mail-Adresse].";
    currentPrompt = base
      .replace('[Thema]', keyword || '')
      .replace('[zus√§tzliche Informationen]', additional || '')
      .replace('[Empf√§nger]',
